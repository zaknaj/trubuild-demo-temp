# ==============================================================================
# TruBuild - Staging Environment Override
# ==============================================================================
# Usage: docker compose -f deploy/docker-compose.yml -f deploy/docker-compose.staging.yml up -d
# ==============================================================================

services:
  # ----------------------------------------------------------------------------
  # App - Staging Configuration
  # ----------------------------------------------------------------------------
  app:
    environment:
      - NODE_ENV=production
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
        labels: "env,service"
    labels:
      - "env=staging"
      - "service=app"

  # ----------------------------------------------------------------------------
  # Engine - Staging Configuration
  # ----------------------------------------------------------------------------
  engine:
    environment:
      - Encryption=true
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
        labels: "env,service"
    labels:
      - "env=staging"
      - "service=engine"

  # ----------------------------------------------------------------------------
  # Nginx - Staging Configuration (HTTPS enabled)
  # ----------------------------------------------------------------------------
  nginx:
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - certbot-conf-staging:/etc/letsencrypt:ro
      - certbot-www-staging:/var/www/certbot:ro
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    labels:
      - "env=staging"
      - "service=nginx"

  # ----------------------------------------------------------------------------
  # PostgreSQL - Staging Configuration
  # ----------------------------------------------------------------------------
  postgres:
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    labels:
      - "env=staging"
      - "service=postgres"

  # ----------------------------------------------------------------------------
  # Engine Worker - Staging Configuration
  # ----------------------------------------------------------------------------
  engine-worker:
    environment:
      - Encryption=true
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
        labels: "env,service"
    labels:
      - "env=staging"
      - "service=engine-worker"

  # ----------------------------------------------------------------------------
  # MinIO - Staging Configuration
  # ----------------------------------------------------------------------------
  minio:
    environment:
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    labels:
      - "env=staging"
      - "service=minio"

# ==============================================================================
# Volumes - Staging SSL certificates
# ==============================================================================
volumes:
  certbot-conf-staging:
    name: certbot-conf-staging
    driver: local
  certbot-www-staging:
    name: certbot-www-staging
    driver: local
