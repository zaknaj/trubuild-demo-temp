# ==============================================================================
# TruBuild - Development Environment Override
# ==============================================================================
# Usage: docker compose -f deploy/docker-compose.yml -f deploy/docker-compose.dev.yml up
# ==============================================================================

services:
  # ----------------------------------------------------------------------------
  # App - Development Configuration
  # ----------------------------------------------------------------------------
  app:
    environment:
      - NODE_ENV=development
      - AUTH_MODE=${AUTH_MODE}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - WORKOS_API_KEY=${WORKOS_API_KEY}
      - WORKOS_CLIENT_ID=${WORKOS_CLIENT_ID}
      - minio_bucket=${minio_bucket}
      - minio_endpoint=${minio_endpoint}
      - minio_root_password=${minio_root_password}
      - minio_root_user=${minio_root_user}
      - postgres_url=${postgres_url}
    # Expose port directly for debugging
    ports:
      - "3000:3000"
    # Mount source for hot reload (optional - comment out if not needed)
    # volumes:
    #   - ../app:/app:ro
    #   - /app/node_modules

  # ----------------------------------------------------------------------------
  # Engine - Development Configuration (Internal Only)
  # ----------------------------------------------------------------------------
  engine:
    environment:
      - Encryption=false
      - FLASK_ENV=development
      - FLASK_DEBUG=1

    # Disable healthcheck in dev (might fail due to missing env vars)
    healthcheck:
      disable: true
    # Engine is internal only - app communicates via Docker network
    # Uncomment below ONLY for direct debugging/testing:
    # ports:
    #   - "5000:5000"
    # Mount source for development (optional)
    # volumes:
    #   - ../engine:/app:ro

  # ----------------------------------------------------------------------------
  # Nginx - Development Configuration (HTTP only, no SSL)
  # ----------------------------------------------------------------------------
  nginx:
    ports:
      - "8080:80"
    volumes:
      - ./nginx/dev.conf:/etc/nginx/conf.d/default.conf:ro

  # ----------------------------------------------------------------------------
  # PostgreSQL - Development Configuration
  # ----------------------------------------------------------------------------
  postgres:
    # Expose port for local database tools
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-devpassword}

  # ----------------------------------------------------------------------------
  # Engine Worker - Development Configuration
  # ----------------------------------------------------------------------------
  engine-worker:
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1

  # ----------------------------------------------------------------------------
  # MinIO - Development Configuration
  # ----------------------------------------------------------------------------
  minio:
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # Web Console (access at http://localhost:9001)
    environment:
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-devpassword}
  

  # ----------------------------------------------------------------------------
  # MinIO Init - Development Configuration
  # ----------------------------------------------------------------------------
  minio-init:
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-trubuild}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-devpassword}

  # ----------------------------------------------------------------------------
  # Loki - Development Configuration
  # ----------------------------------------------------------------------------
  loki:
    ports:
      - "3100:3100"   # Loki API (for debugging/direct queries)
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-trubuild}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-devpassword}
  # ----------------------------------------------------------------------------
  # Grafana - Development Configuration
  # ----------------------------------------------------------------------------
  grafana:
    ports:
      - "3001:3000"   # Grafana Web UI (access at http://localhost:3001)
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-devpassword}
      - GF_SERVER_ROOT_URL=http://localhost:3001
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
