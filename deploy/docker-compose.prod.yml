# ==============================================================================
# TruBuild - Production Environment Override
# ==============================================================================
# Usage: docker compose -f deploy/docker-compose.yml -f deploy/docker-compose.prod.yml up -d
# ==============================================================================

services:
  # ----------------------------------------------------------------------------
  # Certbot - SSL Certificate Management (Let's Encrypt)
  # ----------------------------------------------------------------------------
  certbot:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile.certbot
    image: trubuild-certbot:${TAG:-latest}
    restart: unless-stopped
    volumes:
      - certbot-conf:/etc/letsencrypt
      - certbot-www:/var/www/certbot
      # Mount Docker socket to allow nginx reload after renewal
      - /var/run/docker.sock:/var/run/docker.sock:ro
    # Check for renewal every 12 hours (only renews if within 30 days of expiry)
    # Uses webroot mode so nginx can stay running (serves /.well-known/acme-challenge/)
    entrypoint: /usr/local/bin/certbot-entrypoint.sh
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "env=production"
      - "service=certbot"

  # ----------------------------------------------------------------------------
  # App - Production Configuration
  # ----------------------------------------------------------------------------
  app:
    restart: always
    environment:
      - NODE_ENV=production
    deploy:
      mode: replicated
      replicas: 2
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
        labels: "env,service"
    labels:
      - "env=production"
      - "service=app"

  # ----------------------------------------------------------------------------
  # Engine - Production Configuration
  # ----------------------------------------------------------------------------
  engine:
    restart: always
    environment:
      - Encryption=true
    deploy:
      mode: replicated
      replicas: 2
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
      update_config:
        parallelism: 1
        delay: 60s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
    logging:
      driver: json-file
      options:
        max-size: "200m"
        max-file: "20"
        labels: "env,service"
    labels:
      - "env=production"
      - "service=engine"

  # ----------------------------------------------------------------------------
  # Nginx - Production Configuration (HTTPS with security hardening)
  # ----------------------------------------------------------------------------
  nginx:
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - certbot-conf:/etc/letsencrypt:ro
      - certbot-www:/var/www/certbot:ro
    depends_on:
      app:
        condition: service_healthy
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
    labels:
      - "env=production"
      - "service=nginx"

  # ----------------------------------------------------------------------------
  # PostgreSQL - Production Configuration
  # ----------------------------------------------------------------------------
  postgres:
    restart: always
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
    labels:
      - "env=production"
      - "service=postgres"
    # Production backup settings - mount backup volume
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - postgres-backups:/backups

  # ----------------------------------------------------------------------------
  # Engine Worker - Production Configuration
  # ----------------------------------------------------------------------------
  engine-worker:
    restart: always
    environment:
      - Encryption=true
    deploy:
      # Worker runs as single instance to avoid duplicate job processing
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
      update_config:
        parallelism: 1
        delay: 60s
        failure_action: rollback
        order: stop-first
      rollback_config:
        parallelism: 1
        delay: 10s
    logging:
      driver: json-file
      options:
        max-size: "200m"
        max-file: "20"
        labels: "env,service"
    labels:
      - "env=production"
      - "service=engine-worker"

  # ----------------------------------------------------------------------------
  # MinIO - Production Configuration
  # ----------------------------------------------------------------------------
  minio:
    restart: always
    environment:
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      # Enable server-side encryption in production
      - MINIO_KMS_SECRET_KEY=${MINIO_KMS_SECRET_KEY}
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
    labels:
      - "env=production"
      - "service=minio"
    # Production - separate backup volume for minio data
    volumes:
      - minio-data:/data
      - minio-backups:/backups

  # ----------------------------------------------------------------------------
  # Loki - Production Configuration
  # ----------------------------------------------------------------------------
  loki:
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    labels:
      - "env=production"
      - "service=loki"

  # ----------------------------------------------------------------------------
  # Promtail - Production Configuration
  # ----------------------------------------------------------------------------
  promtail:
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "3"
    labels:
      - "env=production"
      - "service=promtail"

  # ----------------------------------------------------------------------------
  # Grafana - Production Configuration
  # ----------------------------------------------------------------------------
  grafana:
    restart: always
    environment:
      - GF_SERVER_ROOT_URL=https://grafana.trubuild.io
      # Production security settings
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SECURITY_STRICT_TRANSPORT_SECURITY=true
      - GF_SECURITY_X_CONTENT_TYPE_OPTIONS=true
      - GF_SECURITY_X_XSS_PROTECTION=true
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    labels:
      - "env=production"
      - "service=grafana"

# ==============================================================================
# Additional Production Volumes
# ==============================================================================
volumes:
  postgres-backups:
    driver: local
  minio-backups:
    driver: local
  # SSL Certificate volumes (shared between nginx and certbot)
  certbot-conf:
    name: certbot-conf
    driver: local
  certbot-www:
    name: certbot-www
    driver: local
